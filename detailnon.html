<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Detail Petugas</title>

    <!-- Bootstrap 5 -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />

    <!-- DataTables -->
    <link
      rel="stylesheet"
      href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css"
    />

    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  </head>
  <body>
    <main class="container py-4">
      <!-- Judul otomatis dari URL -->
      <h1 id="pageTitle" class="h5 mb-2">Detail Petugas</h1>
      <div class="text-center">
        <p id="petugasInfo" class="text-muted"></p>
      </div>

      <div class="d-flex justify-content-between align-items-center mb-3">
        <button
          type="button"
          class="btn btn-outline-danger btn-sm"
          onclick="history.back()"
        >
          <i class="bi bi-arrow-left"></i> Kembali
        </button>
        <button id="btnPrintLaporan" class="btn btn-danger btn-sm">
          üñ®Ô∏è Print Laporan
        </button>
      </div>

      <!-- Table utama -->
      <div class="table-responsive mb-4" style="font-size: 13px">
        <table
          id="detailTable"
          class="display table table-striped"
          style="width: 100%"
        ></table>
      </div>
    </main>

    <!-- Modal Bootstrap -->
    <div class="modal fade" id="detailModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Data Tambahan</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <!-- Layout dua kolom: label - nilai -->
            <div id="modalContent" class="container-fluid">
              <!-- Konten akan diisi via JS -->
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- JS -->
    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
      const params = new URLSearchParams(window.location.search);
      const apiUrl = params.get("api");

      // ambil nama dari parameter di dalam apiUrl
      // Ambil nama dan jabatan dari parameter di dalam apiUrl
      let petugasNama = "";
      let petugasJabatan = "";
      let petugasNIP = "";

      if (apiUrl) {
        const innerParams = new URLSearchParams(apiUrl.split("?")[1]);
        petugasNama = innerParams.get("nama") || "";
        petugasJabatan = innerParams.get("jabatan") || "";
        petugasNIP = innerParams.get("nip") || ""; // pakai lowercase
        petugasImg = innerParams.get("ttd") || ""; // pakai lowercase
      }

      // Set judul halaman & label petugas
      if (petugasNama) {
        document.getElementById("pageTitle").textContent =
          "Detail Petugas: " + petugasNama;

        document.getElementById("petugasInfo").innerHTML = `
    <span class="badge bg-primary">
      Petugas: ${petugasNama} | 
      Jabatan: ${petugasJabatan} | 
      ${petugasNIP.startsWith("NIP") ? petugasNIP : "NIP. " + petugasNIP}
    </span>`;
      }

      $(document).ready(function () {
        if (!apiUrl) return;

        // Tampilkan loading pakai SweetAlert
        Swal.fire({
          title: "Memuat Data...",
          text: "Mohon tunggu sebentar",
          allowOutsideClick: false,
          didOpen: () => {
            Swal.showLoading();
          },
        });

        fetch(apiUrl)
          .then((res) => res.json())
          .then((json) => {
            Swal.close(); // tutup loading setelah fetch selesai

            if (!json.success || !json.headers || !json.data) {
              Swal.fire("Error", "Format data tidak sesuai", "error");
              return;
            }

            const headers = json.headers;
            const data = json.data;

            // Tentukan kolom yang ditampilkan di tabel utama
            const tampilKolom = [
              "No",
              "Etiket",
              "Tanggal",
              "Nama",
              "NIK",
              "JK",
              "Umur",
              "Desa",
            ];

            const tableData = data.map((row) => row);

            const tableColumns = tampilKolom.map((col) => {
              if (col === "Etiket") {
                return {
                  title: col,
                  data: col,
                  render: function (data, type, row, meta) {
                    return `<input type="text" class="form-control form-control-sm etiket-input"
                              value="${data || ""}" data-index="${
                      row.index
                    }" />`;
                  },
                };
              } else if (col === "Tanggal_Lahir") {
                return {
                  title: col,
                  data: col,
                  render: function (data, type, row, meta) {
                    if (!data) return "-";
                    const date = new Date(data);
                    const options = {
                      day: "2-digit",
                      month: "long",
                      year: "numeric",
                    };
                    return date.toLocaleDateString("id-ID", options); // Output: 09 Mei 2022
                  },
                };
              } else if (col === "Tanggal") {
  return {
    title: col,
    data: col,
    render: function (data, type, row, meta) {
      console.log("DEBUG Tanggal:", data, row); // üîé cek di console data yang masuk

      // ambil langsung dari row (antisipasi kalau 'data' kosong)
      let val = row[col] || "";

      // pastikan format cocok YYYY-MM-DD
      if (val) {
        const d = new Date(val);
        if (!isNaN(d)) {
          const year = d.getFullYear();
          const month = String(d.getMonth() + 1).padStart(2, "0");
          const day = String(d.getDate()).padStart(2, "0");
          val = `${year}-${month}-${day}`;
        }
      }

      return `<input type="date" class="form-control form-control-sm tanggal-input"
                value="${val}" data-index="${meta.row}" />`;
    },
  };
}
 else {
                return { title: col, data: col };
              }
            });

            // Tambahkan tombol Detail
            tableColumns.push({
              title: "Detail",
              orderable: false,
              searchable: false,
              render: function (data, type, row, meta) {
                return `<button class="btn btn-sm btn-primary view-detail" data-index="${row.index}">Lihat</button>`;
              },
            });

            const dt = $("#detailTable").DataTable({
              data: tableData,
              columns: tableColumns,
              pageLength: 10,
              autoWidth: false,
            });

            // Event tombol Detail ‚Üí buka modal
            $("#detailTable").on("click", ".view-detail", function () {
              const rowIndex = $(this).data("index");
              const rowData = data.find((d) => d.index === rowIndex);

              const modalContent = document.getElementById("modalContent");
              modalContent.innerHTML = "";

              headers.forEach((header) => {
                if (!tampilKolom.includes(header)) {
                  const value =
                    rowData[header] !== undefined && rowData[header] !== ""
                      ? rowData[header]
                      : "-";

                  const row = document.createElement("div");
                  row.className = "row py-2 border-bottom";

                  const labelCol = document.createElement("div");
                  labelCol.className = "col-sm-8 fw-semibold"; // label normal
                  labelCol.textContent = header;

                  const valueCol = document.createElement("div");
                  valueCol.className = "col-sm-4 text-muted small"; // jawaban lebih kecil & abu
                  valueCol.textContent = value;

                  row.appendChild(labelCol);
                  row.appendChild(valueCol);

                  modalContent.appendChild(row);
                }
              });

              const modal = new bootstrap.Modal(
                document.getElementById("detailModal")
              );
              modal.show();
            });

            // Event update Etiket
            $("#detailTable").on("change", ".etiket-input", function () {
              const rowIndex = $(this).data("index");
              const newValue = $(this).val();

              fetch(apiUrl, {
                method: "POST",
                body: new URLSearchParams({
                  action: "edit",
                  index: rowIndex,
                  Etiket: newValue,
                }),
              })
                .then((res) => res.json())
                .then((res) => {
                  if (res.success) {
                    Swal.fire({
                      icon: "success",
                      title: "Berhasil!",
                      text: "Etiket berhasil diperbarui.",
                      timer: 1500,
                      showConfirmButton: false,
                    });
                  } else {
                    Swal.fire("Gagal!", res.message, "error");
                  }
                })
                .catch((err) => {
                  Swal.fire(
                    "Error!",
                    "Tidak dapat terhubung ke server",
                    "error"
                  );
                  console.error(err);
                });
            });
            // ‚úÖ Event update Tanggal
            $("#detailTable").on("change", ".tanggal-input", function () {
              const rowIndex = $(this).data("index");
              const newValue = $(this).val();

              fetch(apiUrl, {
                method: "POST",
                body: new URLSearchParams({
                  action: "edit",
                  index: rowIndex,
                  Tanggal: newValue, // kirim field Tanggal
                }),
              })
                .then((res) => res.json())
                .then((res) => {
                  if (res.success) {
                    Swal.fire({
                      icon: "success",
                      title: "Berhasil!",
                      text: "Tanggal berhasil diperbarui.",
                      timer: 1500,
                      showConfirmButton: false,
                    });
                  } else {
                    Swal.fire("Gagal!", res.message, "error");
                  }
                })
                .catch((err) => {
                  Swal.fire(
                    "Error!",
                    "Tidak dapat terhubung ke server",
                    "error"
                  );
                  console.error(err);
                });
            });
          })
          .catch((err) => {
            Swal.close();
            console.error(err);
            Swal.fire("Error", "Gagal mengambil data dari API", "error");
          });
      });
      $("#btnPrintLaporan").on("click", function () {
        const table = $("#detailTable").DataTable();
        const filteredData = table.rows({ search: "applied" }).data().toArray();

        if (filteredData.length === 0) {
          alert("‚ö†Ô∏è Tidak ada data untuk dicetak.");
          return;
        }

        // Ambil bulan yang sedang difilter
        // const bulan = $("#bulanFilterRekapTable").val();
        localStorage.setItem("data_pkg", JSON.stringify(filteredData));
        localStorage.setItem("bulan_pkg", "Semua");
        localStorage.setItem("petugas_nama", petugasNama); // <-- Tambahkan ini
        localStorage.setItem("petugas_jabatan", petugasJabatan); // <-- Tambahkan ini
        localStorage.setItem("petugas_nip", petugasNIP); // <-- Tambahkan ini
        localStorage.setItem("petugas_img", petugasImg); // <-- Tambahkan ini

        window.open("reportlain.html", "_blank");
      });
    </script>
  </body>
</html>
