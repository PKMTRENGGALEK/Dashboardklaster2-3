<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Rekap Per Bulan & Grafik Umur</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      background: linear-gradient(to bottom right, #ffffff, #ffe6f0);
    }
    .table thead th,
    .table tbody td {
      vertical-align: middle;
      text-align: center;
      font-size: 0.8rem;
    }
    .loading-row {
      color: #888;
      font-style: italic;
      background-color: #f9f9f9;
    }
    .card-custom {
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
      border-radius: 1rem;
      padding: 1.5rem;
      background-color: #ffffffcc;
    }
  </style>
</head>
<body>
  <div class="container my-4">
    <a href="../index.html" class="btn btn-outline-danger mb-3">⬅️ Kembali</a>

    <h4 class="mb-4 text-center">Rekap Per Bulan (Total Data Per Orang)</h4>
    <div class="table-responsive">
      <table class="table table-bordered table-hover table-sm">
        <thead class="table-success">
          <tr>
            <th>Nama</th>
            <th>Jan</th><th>Feb</th><th>Mar</th><th>Apr</th>
            <th>Mei</th><th>Jun</th><th>Jul</th><th>Agu</th>
            <th>Sep</th><th>Okt</th><th>Nov</th><th>Des</th>
          </tr>
        </thead>
        <tbody id="rekapPerBulanBody"></tbody>
      </table>
    </div>

    <div class="mt-5 card-custom">
      <h5 class="text-center mb-4">Grafik Kelompok Umur Anak</h5>
      <div class="row mb-3">
        <div class="col-md-4 offset-md-4">
          <label for="bulanFilter" class="form-label">Filter Bulan:</label>
          <select id="bulanFilter" class="form-select">
            <option value="all">Semua Bulan</option>
          </select>
        </div>
      </div>
      <canvas id="umurChart" height="120"></canvas>
    </div>
  </div>

  <script>
    const dataSources = [
      { nama: "Astutik", url: "https://script.google.com/macros/s/AKfycbyQdKG8jBEzdktE6wOkUCKlrKOwFW4y2kV6Y0ArEYK2DaxubZLLxIWfZQScuWOdDWCFeg/exec" },
      { nama: "Dewi Novitasari", url: "https://script.google.com/macros/s/AKfycbyG4WFdT9obD19GRy-2WCqNBHw6EpMwgg1ZcA7TRXhht7MaE1Vh-oU0cNN0HH3ycU3_Ag/exec" },
      { nama: "Eny Karyawati", url: "https://script.google.com/macros/s/AKfycbzZndjXTJEtNKFR7bo548fevn3AygY_k9qJ3FnDSLWMVLGNHvfQztPmXEukAmoT76AKUA/exec" },
      { nama: "Fitria Rahmawati", url: "https://script.google.com/macros/s/AKfycbxxYTTuHglcXtgipsbjUosYFK0RbzWQJ8lTMPcTWsjYQeiejWuJlAGGP7QziJ-7mmu9rg/exec" },
      { nama: "Ninik Wardiati", url: "https://script.google.com/macros/s/AKfycbwnj5wVypjcFFHtm0byEn3l49f2DemTpm6xzpJjeFsD2pvw0x5u4AygIpKtcB3vELoYQw/exec" },
      { nama: "Paryati", url: "https://script.google.com/macros/s/AKfycbyPbGW_4JSS695M5Qd8qi55tuHkj3fR_W11HY5yN-orKjBi5xDqMc3JZSuC5BZqXmOmGA/exec" },
      { nama: "Yuyun Wahyu Retnowati", url: "https://script.google.com/macros/s/AKfycby6zsq2hvG9G1DCS6iY_2K6LN-nXmc3mftlgcg7ocWPeg-gb7DSiUxvA8DrFex7cjWJvA/exec" },
      { nama: "Wahyu Puji L", url: "https://script.google.com/macros/s/AKfycbxNqHI4oql4voEXdLSR4IGucv3A0c6b4i88aHfj7pleolH-uYdt9j8VqFSujos9NpKblA/exec" },
    ];

    const $tbody = document.getElementById("rekapPerBulanBody");
    const bulanFilter = document.getElementById("bulanFilter");
    let semuaData = [];

    function createLoadingRow(nama) {
      const row = document.createElement("tr");
      row.id = `loading-${nama.replace(/\s+/g, "-")}`;
      row.className = "loading-row";
      row.innerHTML = `<td colspan="13">Memuat data ${nama}...</td>`;
      return row;
    }

    function parseUmur(umurStr) {
      const match = umurStr.match(/(\d+)\s*thn.*?(\d+)\s*bln/);
      if (!match) return null;
      return parseInt(match[1]) * 12 + parseInt(match[2]);
    }

    function ambilBulan(tgl) {
      if (!tgl) return null;
      let parts = tgl.includes("/") ? tgl.split("/") : tgl.split("-");
      if (parts.length === 3) {
        return tgl.includes("/") ? parts[0] : parts[1];
      }
      return null;
    }

    function tampilkanBulanFilter(data) {
      const bulanSet = new Set();
      data.forEach(d => {
        d.rows.forEach(row => {
          const bln = ambilBulan(row["TANGGAL"] || row["Tanggal"] || "");
          if (bln) bulanSet.add(bln.padStart(2, "0"));
        });
      });
      const sorted = Array.from(bulanSet).sort();
      sorted.forEach(b => {
        const option = document.createElement("option");
        option.value = b;
        option.textContent = `Bulan ${b}`;
        bulanFilter.appendChild(option);
      });
    }

    function tampilkanGrafikKelompokUmur(dataSemua, bulanDipilih = "all") {
      const kelompok = {
        "Bayi Baru Lahir (0–28 hari)": 0,
        "Bayi & Balita (<5 thn)": 0,
        "Usia Pra Sekolah (5–7 thn)": 0,
        "Usia Sekolah (7–10 thn)": 0
      };

      dataSemua.forEach((obj) => {
        obj.rows.forEach((row) => {
          const bulan = ambilBulan(row["TANGGAL"] || row["Tanggal"] || "");
          if (bulanDipilih !== "all" && bulan !== bulanDipilih) return;

          const umurStr = row["UMUR"] || row["Umur"] || "";
          const totalBulan = parseUmur(umurStr);
          if (totalBulan === null || isNaN(totalBulan)) return;

          if (totalBulan <= 0) kelompok["Bayi Baru Lahir (0–28 hari)"]++;
          else if (totalBulan <= 59) kelompok["Bayi & Balita (<5 thn)"]++;
          else if (totalBulan <= 84) kelompok["Usia Pra Sekolah (5–7 thn)"]++;
          else if (totalBulan <= 120) kelompok["Usia Sekolah (7–10 thn)"]++;
        });
      });

      if (window.chartUmur) window.chartUmur.destroy();

      const ctx = document.getElementById('umurChart').getContext('2d');
      window.chartUmur = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: Object.keys(kelompok),
          datasets: [{
            label: 'Jumlah Anak',
            data: Object.values(kelompok),
            backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0'],
            borderColor: '#333',
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: false },
            title: { display: true, text: 'Distribusi Kelompok Umur Anak' },
            tooltip: { enabled: true }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: { stepSize: 1 }
            }
          }
        },
        plugins: [{
          id: 'valueOnTop',
          afterDatasetsDraw(chart) {
            const { ctx, chartArea: { top }, data } = chart;
            chart.getDatasetMeta(0).data.forEach((bar, index) => {
              const value = data.datasets[0].data[index];
              ctx.save();
              ctx.font = 'bold 12px sans-serif';
              ctx.fillStyle = '#000';
              ctx.textAlign = 'center';
              ctx.fillText(value, bar.x, bar.y - 5);
              ctx.restore();
            });
          }
        }]
      });
    }

    function fetchAndProcess() {
      dataSources.forEach(source => {
        $tbody.appendChild(createLoadingRow(source.nama));
      });

      Promise.all(
        dataSources.map(source =>
          fetch(source.url)
            .then(res => res.json())
            .then(json => {
              const data = (json.data || []).filter(row =>
                Object.values(row).some(val => val !== "" && val != null)
              );

              const bulanCount = Array(12).fill(0);
              data.forEach(row => {
                const tgl = row["Tanggal"] || row["TANGGAL"] || "";
                const parts = tgl.split("/");
                let date = new Date(tgl);
                if (parts.length === 3) {
                  date = new Date(`${parts[2]}-${parts[0].padStart(2, "0")}-${parts[1].padStart(2, "0")}`);
                }
                if (!isNaN(date)) {
                  const month = date.getMonth();
                  bulanCount[month]++;
                }
              });

              return { nama: source.nama, count: bulanCount, rows: data };
            })
            .catch(() => ({ nama: source.nama, count: Array(12).fill("-"), rows: [] }))
        )
      ).then(allResults => {
        semuaData = allResults;

        allResults.forEach(res => {
          const row = document.createElement("tr");
          row.innerHTML = `<td>${res.nama}</td>` + res.count.map(n => `<td>${n}</td>`).join("");
          const loadingRow = document.getElementById(`loading-${res.nama.replace(/\s+/g, "-")}`);
          if (loadingRow) $tbody.replaceChild(row, loadingRow);
        });

        tampilkanBulanFilter(allResults);
        tampilkanGrafikKelompokUmur(allResults);
      });
    }

    bulanFilter.addEventListener("change", () => {
      tampilkanGrafikKelompokUmur(semuaData, bulanFilter.value);
    });

    window.addEventListener("DOMContentLoaded", fetchAndProcess);
  </script>
</body>
</html>
