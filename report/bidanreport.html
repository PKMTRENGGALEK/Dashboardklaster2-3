<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Rekap Per Bulan & Grafik Umur</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
    <style>
      body {
        background: linear-gradient(to bottom right, #ffffff, #ffe6f0);
      }
      .table thead th,
      .table tbody td {
        vertical-align: middle;
        text-align: center;
        font-size: 0.8rem;
      }
      .loading-row {
        color: #888;
        font-style: italic;
        background-color: #f9f9f9;
      }
      .card-custom {
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
        border-radius: 1rem;
        padding: 1.5rem;
        background-color: #ffffffcc;
      }
      h4,
      h5 {
        font-weight: bold;
        color: #004d40;
      }

      .table thead th {
        background-color: #d0f0c0 !important;
        color: #004d40;
      }

      select#bulanFilter {
        border-radius: 0.5rem;
        font-weight: 500;
      }
    </style>
  </head>
  <body>
    <div class="container my-4">
      <a href="../index.html" class="btn btn-outline-danger mb-3">⬅️ Kembali</a>

      <h4 class="mb-4 text-center">Rekap Per Bulan (Total Data Per Orang)</h4>
      <div class="table-responsive">
        <table class="table table-bordered table-hover table-sm">
          <thead class="table-success">
            <tr>
              <th>Nama</th>
              <th>Jan</th>
              <th>Feb</th>
              <th>Mar</th>
              <th>Apr</th>
              <th>Mei</th>
              <th>Jun</th>
              <th>Jul</th>
              <th>Agu</th>
              <th>Sep</th>
              <th>Okt</th>
              <th>Nov</th>
              <th>Des</th>
            </tr>
          </thead>
          <tbody id="rekapPerBulanBody"></tbody>
        </table>
      </div>

      <div class="mt-5 card-custom">
        <h5 class="text-center mb-4">Grafik Kelompok Umur Anak</h5>
        <div class="row mb-3">
          <div class="col-md-4 offset-md-4">
            <label for="bulanFilter" class="form-label">Filter Bulan:</label>
            <select id="bulanFilter" class="form-select">
              <option value="all">Semua Bulan</option>
            </select>
          </div>
        </div>
        <div class="row justify-content-center align-items-center">
          <div class="col-md-5 text-center">
            <canvas
              id="tampilkanGrafikKelompokUmur"
              width="500"
              height="500"
              style="padding: 30px"
            ></canvas>
          </div>
          <div class="col-md-5">
            <div
              id="infoKelompokUmur"
              class="p-3 rounded"
              style="
                background-color: #e8f5e9;
                color: #004d40;
                font-size: 0.9rem;
              "
            >
              <p>
                <strong>Total Anak:</strong> <span id="totalAnakText">0</span>
              </p>
              <ul class="mb-0 ps-3">
                <li>
                  <strong>0–3 Tahun</strong>:
                  <span id="kelompok_0_3">0</span> anak (Balita awal)
                </li>
                <li>
                  <strong>3–5 Tahun</strong>:
                  <span id="kelompok_3_5">0</span> anak (Balita akhir)
                </li>
                <li>
                  <strong>5–7 Tahun</strong>:
                  <span id="kelompok_5_7">0</span> anak (Usia prasekolah)
                </li>
              </ul>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      const dataSources = [
        {
          nama: "(Ruang Ibu) Astutik",
          url: "https://script.google.com/macros/s/AKfycbyQdKG8jBEzdktE6wOkUCKlrKOwFW4y2kV6Y0ArEYK2DaxubZLLxIWfZQScuWOdDWCFeg/exec",
        },
        {
          nama: "(Ruang Anak & Remaja) Dewi Novitasari",
          url: "https://script.google.com/macros/s/AKfycbyG4WFdT9obD19GRy-2WCqNBHw6EpMwgg1ZcA7TRXhht7MaE1Vh-oU0cNN0HH3ycU3_Ag/exec",
        },
        {
          nama: "(Kelurahan Sumbergedong) Eny Karyawati",
          url: "https://script.google.com/macros/s/AKfycbzZndjXTJEtNKFR7bo548fevn3AygY_k9qJ3FnDSLWMVLGNHvfQztPmXEukAmoT76AKUA/exec",
        },
        {
          nama: "(Kelurahan Tamanan) Fitria Rahmawati",
          url: "https://script.google.com/macros/s/AKfycbxxYTTuHglcXtgipsbjUosYFK0RbzWQJ8lTMPcTWsjYQeiejWuJlAGGP7QziJ-7mmu9rg/exec",
        },
        {
          nama: "(Desa Sambirejo) Ninik Wardiati",
          url: "https://script.google.com/macros/s/AKfycbwnj5wVypjcFFHtm0byEn3l49f2DemTpm6xzpJjeFsD2pvw0x5u4AygIpKtcB3vELoYQw/exec",
        },
        {
          nama: "(Kelurahan Kelutan) Paryati",
          url: "https://script.google.com/macros/s/AKfycbyPbGW_4JSS695M5Qd8qi55tuHkj3fR_W11HY5yN-orKjBi5xDqMc3JZSuC5BZqXmOmGA/exec",
        },
        {
          nama: "(Desa Karangsoko) Yuyun Wahyu Retnowati",
          url: "https://script.google.com/macros/s/AKfycby6zsq2hvG9G1DCS6iY_2K6LN-nXmc3mftlgcg7ocWPeg-gb7DSiUxvA8DrFex7cjWJvA/exec",
        },
        {
          nama: "(Kelurahan Ngantru) Wahyu Puji L",
          url: "https://script.google.com/macros/s/AKfycbxNqHI4oql4voEXdLSR4IGucv3A0c6b4i88aHfj7pleolH-uYdt9j8VqFSujos9NpKblA/exec",
        },
      ];

      const $tbody = document.getElementById("rekapPerBulanBody");
      const bulanFilter = document.getElementById("bulanFilter");
      let semuaData = [];

      function createLoadingRow(nama) {
        const row = document.createElement("tr");
        row.id = `loading-${nama.replace(/\s+/g, "-")}`;
        row.className = "loading-row";
        row.innerHTML = `
        <td colspan="13">
          <div class="d-flex align-items-center justify-content-start">
            <div class="spinner-border text-success me-2" role="status" style="width: 1rem; height: 1rem;">
              <span class="visually-hidden">Loading...</span>
            </div>
            <span>Memuat data ${nama}...</span>
          </div>
        </td>`;
        return row;
      }

      function parseUmur(umurStr) {
        const match = umurStr.match(/(\d+)\s*thn.*?(\d+)\s*bln/);
        if (!match) return null;
        return parseInt(match[1]) * 12 + parseInt(match[2]);
      }

      function ambilBulan(tgl) {
        if (!tgl) return null;
        let parts = tgl.includes("/") ? tgl.split("/") : tgl.split("-");
        if (parts.length === 3) {
          return tgl.includes("/") ? parts[0] : parts[1];
        }
        return null;
      }

      function tampilkanBulanFilter(data) {
        const bulanSet = new Set();
        data.forEach((d) => {
          d.rows.forEach((row) => {
            const bln = ambilBulan(row["TANGGAL"] || row["Tanggal"] || "");
            if (bln) bulanSet.add(bln.padStart(2, "0"));
          });
        });
        const sorted = Array.from(bulanSet).sort();
        sorted.forEach((b) => {
          const option = document.createElement("option");
          option.value = b;
          option.textContent = `Bulan ${b}`;
          bulanFilter.appendChild(option);
        });
      }

      function tampilkanGrafikKelompokUmur(dataSemua, bulanDipilih = "all") {
        const kelompok = {
          "0–3 Tahun": 0,
          "3–5 Tahun": 0,
          "5–7 Tahun": 0,
        };

        dataSemua.forEach((obj) => {
          obj.rows.forEach((row) => {
            const bulan = ambilBulan(row["TANGGAL"] || row["Tanggal"] || "");
            if (bulanDipilih !== "all" && bulan !== bulanDipilih) return;

            const umurStr = row["UMUR"] || row["Umur"] || "";
            const totalBulan = parseUmur(umurStr);
            if (totalBulan === null || isNaN(totalBulan)) return;

            if (totalBulan <= 36) kelompok["0–3 Tahun"]++;
            else if (totalBulan <= 60) kelompok["3–5 Tahun"]++;
            else if (totalBulan <= 84) kelompok["5–7 Tahun"]++;
          });
        });

        if (window.chartUmur) window.chartUmur.destroy();

        const ctx = document
          .getElementById("tampilkanGrafikKelompokUmur")
          .getContext("2d");
        window.chartUmur = new Chart(ctx, {
          type: "doughnut",
          data: {
            labels: Object.keys(kelompok),
            datasets: [
              {
                data: Object.values(kelompok),
                backgroundColor: ["#ff8a80", "#ffd180", "#80d8ff"],
                borderColor: "#fff",
                borderWidth: 2,
              },
            ],
          },
          options: {
            responsive: true,
            layout: {
              padding: 30, // Tambahkan padding agar label tidak mentok
            },
            cutout: "60%", // Perkecil lingkaran tengah untuk ruang label
            plugins: {
              legend: {
                display: true,
                position: "bottom",
                labels: {
                  font: {
                    size: 14,
                  },
                },
              },
              title: {
                display: true,
                text: "Distribusi Usia Anak (0–7 Tahun)",
                font: {
                  size: 18,
                  weight: "bold",
                },
              },
              tooltip: {
                callbacks: {
                  label: function (context) {
                    let label = context.label || "";
                    let value = context.raw || 0;
                    return `${label}: ${value} anak`;
                  },
                },
              },
            },
          },

          plugins: [
            {
              id: "valueInsideDonut",
              afterDraw(chart) {
                const {
                  ctx,
                  chartArea: { width, height },
                } = chart;
                const total = chart.data.datasets[0].data.reduce(
                  (a, b) => a + b,
                  0
                );
                ctx.save();
                ctx.font = "bold 18px sans-serif";
                ctx.fillStyle = "#333";
                ctx.textAlign = "center";
                ctx.fillText(
                  `${total} Anak`,
                  chart.width / 2,
                  chart.height / 2
                );
                ctx.restore();

                const totalTextEl = document.getElementById("totalAnakText");
                if (totalTextEl) totalTextEl.textContent = total;
              },
            },
            {
              id: "labelPerBagian",
              afterDatasetsDraw(chart) {
                const { ctx, chartArea, width, height } = chart;
                const dataset = chart.data.datasets[0];
                const meta = chart.getDatasetMeta(0);

                meta.data.forEach((arc, index) => {
                  const value = dataset.data[index];
                  const label = chart.data.labels[index];
                  const radius = arc.outerRadius;
                  const midAngle = (arc.startAngle + arc.endAngle) / 2;

                  let x = chart.width / 2 + Math.cos(midAngle) * (radius + 20);
                  let y = chart.height / 2 + Math.sin(midAngle) * (radius + 20);

                  // Batas aman (jangan sampai keluar dari area chart)
                  if (x < chartArea.left + 20) x = chartArea.left + 20;
                  if (x > chartArea.right - 20) x = chartArea.right - 20;
                  if (y < chartArea.top + 20) y = chartArea.top + 20;
                  if (y > chartArea.bottom - 20) y = chartArea.bottom - 20;

                  ctx.save();
                  ctx.font = "bold 12px sans-serif";
                  ctx.fillStyle = "#444";
                  ctx.textAlign = "center";
                  ctx.textBaseline = "middle";
                  ctx.fillText(`${label}: ${value}`, x, y);
                  ctx.restore();
                });
              },
            },
          ],
        });
        // Update jumlah per kelompok ke panel info
        document.getElementById("kelompok_0_3").textContent =
          kelompok["0–3 Tahun"];
        document.getElementById("kelompok_3_5").textContent =
          kelompok["3–5 Tahun"];
        document.getElementById("kelompok_5_7").textContent =
          kelompok["5–7 Tahun"];
      }

      function fetchAndProcess() {
        dataSources.forEach((source) => {
          $tbody.appendChild(createLoadingRow(source.nama));
        });

        Promise.all(
          dataSources.map((source) =>
            fetch(source.url)
              .then((res) => res.json())
              .then((json) => {
                const data = (json.data || []).filter((row) =>
                  Object.values(row).some((val) => val !== "" && val != null)
                );

                const bulanCount = Array(12).fill(0);
                data.forEach((row) => {
                  const tgl = row["Tanggal"] || row["TANGGAL"] || "";
                  const parts = tgl.split("/");
                  let date = new Date(tgl);
                  if (parts.length === 3) {
                    date = new Date(
                      `${parts[2]}-${parts[0].padStart(
                        2,
                        "0"
                      )}-${parts[1].padStart(2, "0")}`
                    );
                  }
                  if (!isNaN(date)) {
                    const month = date.getMonth();
                    bulanCount[month]++;
                  }
                });

                return { nama: source.nama, count: bulanCount, rows: data };
              })
              .catch(() => ({
                nama: source.nama,
                count: Array(12).fill("-"),
                rows: [],
              }))
          )
        ).then((allResults) => {
          semuaData = allResults;

          allResults.forEach((res) => {
            const row = document.createElement("tr");
            row.innerHTML =
              `<td class="text-start">${res.nama}</td>` +
              res.count.map((n) => `<td>${n}</td>`).join("");
            const loadingRow = document.getElementById(
              `loading-${res.nama.replace(/\s+/g, "-")}`
            );
            if (loadingRow) $tbody.replaceChild(row, loadingRow);
          });

          tampilkanBulanFilter(allResults);
          tampilkanGrafikKelompokUmur(allResults);
        });
      }

      bulanFilter.addEventListener("change", () => {
        tampilkanGrafikKelompokUmur(semuaData, bulanFilter.value);
      });

      window.addEventListener("DOMContentLoaded", fetchAndProcess);
    </script>
  </body>
</html>
